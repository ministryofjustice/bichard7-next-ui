version: 2.1

commands:
  npm_install:
    description: Check out the repo and install the node dependencies
    steps:
      - run:
          name: Hash package lock
          command: ./.circleci/scripts/hash-package-lock.sh
      - restore_cache:
          name: Load node_modules from the cache if they haven't changed
          keys:
            - v1-npm-deps-{{ checksum "package-lock.json.md5" }}
            - v1-npm-deps-
      - run:
          name: Install node dependencies
          command: npm i

  clone_bichard_repo:
    description: Check out the bichard7-next repo
    steps:
      - add_ssh_keys:
          fingerprints:
            - 56:12:d8:11:e2:11:41:bc:f3:29:b7:ba:cc:d5:0c:5a
      - run:
          name: Clone Bichard7 Next
          command: git clone --depth 1 git@github.com:ministryofjustice/bichard7-next.git ~/bichard7-next

  run_postgres:
    description: Run the PostgreSQL database
    steps:
      - run:
          name: Spin up the PostgreSQL database
          working_directory: ~/bichard7-next
          command: make run-pg

  run_mq:
    description: Run MQ
    steps:
      - run:
          name: Spin up MQ
          working_directory: ~/bichard7-next
          command: make run-activemq

  use_nvm_version:
    description: Install nvm and use configured node version
    steps:
      - run:
          label: Use nvm for a specific node version...
          command: |
            set +e
            export NVM_DIR="/opt/circleci/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install
            nvm use

  checkout-tests:
    steps:
      - run:
          name: Git clone e2e tests
          command: git clone --depth 1 https://github.com/ministryofjustice/bichard7-next-tests.git ~/bichard7-next-tests

  fetch_docker_image:
    parameters:
      image:
        type: string
    steps:
      - run:
          name: Fetch the <<parameters.image>> image
          working_directory: ~/bichard7-next
          command: bash scripts/fetch_docker_image.sh <<parameters.image>>
          background: true

jobs:
  lint:
    docker:
      - image: cimg/node:16.12.0
    resource_class: medium
    working_directory: ~
    steps:
      - checkout
      - npm_install
      - save_cache:
          name: Save node_modules cache
          key: v1-npm-deps-{{ checksum "package-lock.json.md5" }}
          paths: node_modules
      - attach_workspace:
          at: .
      - run:
          name: Check the code for linting errors
          command: npm run lint

  unit_test:
    docker:
      - image: cimg/node:16.12.0
    resource_class: medium
    working_directory: ~
    steps:
      - checkout
      - npm_install
      - attach_workspace:
          at: .
      - run:
          name: Run code-based unit tests
          command: npm run test:unit

  integration_test:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: true
    working_directory: ~
    steps:
      - checkout
      - use_nvm_version
      - npm_install
      - attach_workspace:
          at: .
      - clone_bichard_repo
      - run_postgres
      - run_mq
      - run:
          name: Run integration tests
          command: npm run test:integration

  ui_test:
    docker:
      - image: cimg/node:16.12.0
    resource_class: large
    working_directory: ~
    environment:
      TZ: "Europe/London"
    steps:
      - checkout
      - npm_install
      - attach_workspace:
          at: .
      - run:
          name: Install Playwright in the background
          command: ./.circleci/scripts/install-playwright.sh
          background: true
      - run:
          name: Build Storybook
          command: npm run build-storybook
      - run:
          name: Wait for Playwright installation to finish
          command: until [ -f playwrightInstalled ]; do sleep 1; done
          no_output_timeout: 5m
      - run:
          name: Run visual unit tests
          command: npm run test:ui:unit:ci

  build_and_cypress_e2e_test:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    resource_class: medium
    working_directory: ~
    parallelism: 5
    steps:
      - checkout
      - clone_bichard_repo
      - fetch_docker_image:
          image: user-service
      - fetch_docker_image:
          image: nginx-auth-proxy
      - run:
          name: Build the UI application in the background
          command: ./.circleci/scripts/build-ui.sh
          background: true
      - run:
          name: Install Cypress
          command: ./.circleci/scripts/install-cypress.sh 2>&1
          background: true
      - use_nvm_version
      - npm_install
      - run:
          name: Install GOV.UK Assets
          command: npm run install:assets
      - attach_workspace:
          at: .
      - run:
          name: Wait for cypress install to finish
          command: until [ -f cypressInstalled ]; do sleep 1; done
          no_output_timeout: 10m
      - run:
          name: Retrying installing Cypress
          command: ./.circleci/scripts/install-cypress.sh
      - run:
          name: Wait for docker images
          command: IMAGES=(ui user-service nginx-auth-proxy) && bash ./scripts/wait_for_images.sh "${IMAGES[@]}"
          no_output_timeout: 15m
      - run:
          name: Run MQ
          working_directory: ~/bichard7-next
          command: COMPOSE_PROJECT_NAME="bichard7" docker-compose up -d activemq
          background: true
      - run:
          name: Run UI stack
          working_directory: ~/bichard7-next
          command: make run-ui
          background: true
      - run:
          name: Wait for UI to start
          command: npx wait-on --config ./.circleci/config/wait-for-401.js https://localhost:4080/bichard
      - run:
          name: Run UI tests
          command: TOTAL_CHUNKS=$CIRCLE_NODE_TOTAL CHUNK_NUMBER=$CIRCLE_NODE_INDEX ./scripts/run-ui-tests-chunk.sh
          environment:
            UI_IS_HTTPS: true
            TZ: "Europe/London"
      - store_artifacts:
          path: ./cypress/videos
      - store_artifacts:
          path: ./cypress/screenshots

  build_and_cypress_component_test:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    resource_class: medium
    working_directory: ~
    steps:
      - checkout
      - clone_bichard_repo
      - fetch_docker_image:
          image: user-service
      - fetch_docker_image:
          image: nginx-auth-proxy
      - run:
          name: Build the UI application in the background
          command: ./.circleci/scripts/build-ui.sh
          background: true
      - run:
          name: Install Cypress
          command: ./.circleci/scripts/install-cypress.sh 2>&1
          background: true
      - use_nvm_version
      - npm_install
      - run:
          name: Install GOV.UK Assets
          command: npm run install:assets
      - attach_workspace:
          at: .
      - run:
          name: Wait for cypress install to finish
          command: until [ -f cypressInstalled ]; do sleep 1; done
          no_output_timeout: 10m
      - run:
          name: Retrying installing Cypress
          command: ./.circleci/scripts/install-cypress.sh
      - run:
          name: Run UI component tests
          command: npm run cypress:run:component:docker
          environment:
            UI_IS_HTTPS: true
            TZ: "Europe/London"
      - store_artifacts:
          path: ./cypress/videos
      - store_artifacts:
          path: ./cypress/screenshots

  e2e_test:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    resource_class: xlarge
    working_directory: ~
    steps:
      - checkout
      - checkout-tests
      - npm_install
      - attach_workspace:
          at: .
      - run:
          name: Build next UI docker image
          command: make build
          background: true
      - clone_bichard_repo
      - fetch_docker_image:
          image: user-service
      - fetch_docker_image:
          image: nginx-auth-proxy
      - fetch_docker_image:
          image: pncemulator
      - fetch_docker_image:
          image: beanconnect
      - run:
          name: Wait for docker images
          command: IMAGES=(ui user-service nginx-auth-proxy pncemulator beanconnect) && bash ./scripts/wait_for_images.sh "${IMAGES[@]}"
          no_output_timeout: 15m
      - run:
          name: Run full stack (excluding beanconnect and PNC emulator)
          working_directory: ~/bichard7-next
          command: |
            make build-ci
            make run-all-no-bc -j 4
      - run:
          name: Run beanconnect and PNC emulator
          working_directory: ~/bichard7-next
          command: make run-beanconnect
      - run:
          name: Wait for Bichard
          working_directory: ~/bichard7-next
          command: bash ./scripts/wait_for_bichard.sh
      - run:
          name: Trying to run beanconnect and PNC emulator again
          working_directory: ~/bichard7-next
          command: make run-beanconnect && bash ./scripts/wait_for_bichard.sh
          when: on_fail
      - run:
          name: Run UI stack
          working_directory: ~/bichard7-next
          command: make run-ui
          background: true
      - run:
          name: Wait for UI to start
          command: npx wait-on --config ./.circleci/config/wait-for-401.js https://localhost:4080/bichard
      - run:
          name: Run end-to-end tests
          working_directory: ~/bichard7-next-tests
          command: npm i && npm run test:nextUI
          environment:
            STACK_TYPE: next
            WORKSPACE: local-next
            AUTH_TYPE: user-service

workflows:
  version: 2
  build-and-test:
    jobs:
      - lint
      - unit_test
      - integration_test
      - ui_test
      - build_and_cypress_e2e_test
      - build_and_cypress_component_test
      - e2e_test

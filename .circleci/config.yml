version: 2.1

orbs:
  node: circleci/node@5.1.0

commands:
  ################### Helpers
  build_core_images:
    steps:
      - run:
          name: Build message forwarder image
          working_directory: ~/bichard7-next-core
          command: docker-compose -f environment/docker-compose.yml build message-forwarder

  build_audit_logging_images:
    steps:
      - run:
          name: Build audit logging images
          working_directory: ~/bichard7-next-audit-logging
          command: make build-api-server build-event-handler-server

  cache_ui_image:
    steps:
      - run:
          name: Save UI docker image
          command: docker save ui > ui.tar
      - save_cache:
          name: Cache UI docker image
          key: ui-image-<<pipeline.git.revision>>
          paths: ui.tar

  load_ui_image:
    steps:
      - restore_cache:
          name: Restore UI docker image from cache
          keys:
            - ui-image-<<pipeline.git.revision>>
      - run:
          name: Load UI docker image
          command: docker load < ui.tar
          background: true

  run_test_chunk:
    parameters:
      NEXTUI:
        default: "false"
        type: "string"
    steps:
      - run:
          name: Run test chunk
          working_directory: ~/bichard7-next-tests
          command: |
            CHUNK=$(circleci tests glob "features/**/*.feature" | circleci tests split --split-by=timings) \
            NEXTUI=<<parameters.NEXTUI>> \
            npm run test:chunk

  ################### Services
  start_bichard7_legacy:
    parameters:
      ENABLE_PHASE_2:
        default: "true"
        type: string
    steps:
      - run:
          name: "Fetch nodejs from ECR"
          working_directory: ~/bichard-next-core
          command: bash scripts/fetch_docker_image.sh nodejs # required for message-forwarder in core
      - build_core_images
      - build_audit_logging_images
      - run:
          name: Start bichard7 legacy
          working_directory: ~/bichard7-next-core
          command: |
            ENABLE_PHASE_2=<<parameters.ENABLE_PHASE_2>> \
            npm run all-legacy
      - run:
          name: Retry - start bichard7 legacy
          working_directory: ~/bichard7-next-core
          when: on_fail
          command: |
            # TODO: add legacy compose to destroy in core
            docker-compose --project-name bichard \
              -f environment/docker-compose.yml \
              -f environment/docker-compose-bichard.yml down -v

            ENABLE_PHASE_2=<<parameters.ENABLE_PHASE_2>> \
            npm run all-legacy

#################################################################################

jobs:
  build:
    docker:
      - image: cimg/node:16.12.0
    resource_class: medium
    steps:
      - checkout
      - node/install
      - node/install-packages
      - run:
          name: Clone bichard7-next-tests
          command: git clone --depth 1 https://github.com/ministryofjustice/bichard7-next-tests.git ~/bichard7-next-tests
      - node/install-packages:
          app-dir: ~/bichard7-next-tests
      - run:
          name: Clone bichard7-next-core
          command: git clone --depth 1 https://github.com/ministryofjustice/bichard7-next-core.git ~/bichard7-next-core
      - node/install-packages:
          app-dir: ~/bichard7-next-core
      - run:
          name: Clone bichard7-next-audit-logging
          command: git clone --depth 1 https://github.com/ministryofjustice/bichard7-next-audit-logging.git ~/bichard7-next-audit-logging
      - persist_to_workspace:
          root: ~/
          path: .

  lint:
    docker:
      - image: cimg/node:16.12.0
    resource_class: medium
    steps:
      - node/install
      - attach_workspace:
          at: .
      - run:
          name: Check the code for linting errors
          command: npm run lint

  unit_test:
    docker:
      - image: cimg/node:16.12.0
    resource_class: medium
    steps:
      - node/install
      - attach_workspace:
          at: .
      - run:
          name: Run code-based unit tests
          command: npm run test:unit

  integration_test:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    steps:
      - node/install
      - attach_workspace:
          at: .
      - start_bichard7_legacy
      - run:
          name: Run integration tests
          command: npm run test:integration

  build_ui_image:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    resource_class: medium
    steps:
      - run:
          name: Build the UI application
          command: ./.circleci/scripts/build-ui.sh
      - cache_ui_image

  cypress_e2e_test:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    resource_class: medium
    parallelism: 5
    steps:
      - attach_workspace:
          at: .
      - load_ui_image
      - run:
          name: Install Cypress
          command: ./.circleci/scripts/install-cypress.sh 2>&1
          background: true
      - run:
          name: Install GOV.UK Assets
          command: npm run install:assets
      - run:
          name: Wait for cypress install to finish
          command: until [ -f cypressInstalled ]; do sleep 1; done
          no_output_timeout: 10m
      - run:
          name: Retrying installing Cypress
          command: ./.circleci/scripts/install-cypress.sh
      - start_bichard7_legacy
      - run:
          name: Run UI tests
          command: TOTAL_CHUNKS=$CIRCLE_NODE_TOTAL CHUNK_NUMBER=$CIRCLE_NODE_INDEX ./scripts/run-ui-tests-chunk.sh
          environment:
            UI_IS_HTTPS: true
            TZ: "Europe/London"
      - store_artifacts:
          path: ./cypress/videos
      - store_artifacts:
          path: ./cypress/screenshots

  cypress_component_test:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    resource_class: medium
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Install Cypress
          command: ./.circleci/scripts/install-cypress.sh 2>&1
          background: true
      - run:
          name: Install GOV.UK Assets
          command: npm run install:assets
      - run:
          name: Wait for cypress install to finish
          command: until [ -f cypressInstalled ]; do sleep 1; done
          no_output_timeout: 10m
      - run:
          name: Retrying installing Cypress
          command: ./.circleci/scripts/install-cypress.sh
      - run:
          name: Run UI component tests
          command: npm run cypress:run:component:docker
          environment:
            UI_IS_HTTPS: true
            TZ: "Europe/London"
      - store_artifacts:
          path: ./cypress/videos
      - store_artifacts:
          path: ./cypress/screenshots

  seed_data:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    steps:
      - attach_workspace:
          at: .
      - start_bichard7_legacy
      - run:
          name: Run the seed-data script
          command: DEPLOY_NAME=e2e-test npm run seed-data

  cucumber_e2e_tests:
    machine:
      image: ubuntu-2004:2022.07.1
      docker_layer_caching: false
    resource_class: xlarge
    parallelism: 10
    environment:
      STACK_TYPE: next
      WORKSPACE: local-next
      AUTH_TYPE: user-service
    steps:
      - attach_workspace:
          at: .
      - load_ui_image
      - start_bichard7_legacy
      - run_test_chunk:
          NEXTUI: "true"

#################################################################################

workflows:
  build-and-test:
    jobs:
      - build
      - build_ui_image
      - seed_data

      - lint:
          requires:
            - build
      - unit_test:
          requires:
            - build
      - integration_test:
          requires:
            - build
      - cypress_component_test:
          requires:
            - build

      - cypress_e2e_test:
          requires:
            - build_ui_image
      - cucumber_e2e_tests:
          requires:
            - build_ui_image

